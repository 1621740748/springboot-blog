<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Newtol_博客详情页</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--引入样式文件-->
  <link rel="stylesheet" href="../../static/editor/css/editormd.preview.css" />
  <!--引入js文件-->
  <script src="../../static/editor/js/editor/jquery.min.js"></script>
  <script src="../../static/editor/js/editor/marked.min.js"></script>
  <script src="../../static/editor/js/editor/prettify.min.js"></script>
  <script src="../../static/editor/js/editor/raphael.min.js"></script>
  <script src="../../static/editor/js/editor/underscore.min.js"></script>
  <script src="../../static/editor/js/editor/sequence-diagram.min.js"></script>
  <script src="../../static/editor/js/editor/flowchart.min.js"></script>
  <script src="../../static/editor/js/editor/jquery.flowchart.min.js"></script>
  <script src="../../static/editor/js/editor/editormd.js"></script>

  <script src="../../static/blog/js/myJs.js"></script>
  <script src="../../static/blog/js/info.js"></script>


  <link href="../../static/blog/css/base.css" rel="stylesheet">
  <link href="../../static/blog/css/index.css" rel="stylesheet">
  <link href="../../static/blog/css/info.css" rel="stylesheet">
  <link href="../../static/blog/css/m.css" rel="stylesheet">
  <script src="../../static/blog/js/jquery.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="../../static/blog/js/comm.js"></script>
<!--[if lt IE 9]>
<script src="../../static/blog/js/modernizr.js"></script>
<![endif]-->
</head>
<body>
<header class="header-navigation" id="header">
  <nav>
    <div class="logo"><a href="/">Newtol个人博客</a></div>
    <h2 id="mnavh"><span class="navicon"></span></h2>
    <ul id="starlist">
      <li><a href="/blog/index">文章</a></li>
      <li><a href="/blog/share">我的相册</a></li>
      <li><a href="/blog/game">我的日记</a></li>
      <li><a href="/blog/about">关于我</a></li>
      <li><a href="/blog/gbook">留言&友链申请</a></li>
      <li><a href="/editor">编辑md简历</a></li>
    </ul>
  </nav>
</header>
<article>
  <aside class="l_box">
    <div class="search">
      <form action="/" method="post" name="searchform" id="searchform">
        <input name="keyboard" id="keyboard" class="input_text" value="请输入关键字词" style="color: rgb(153, 153, 153);" onfocus="if(value=='请输入关键字词'){this.style.color='#000';value=''}" onblur="if(value==''){this.style.color='#999';value='请输入关键字词'}" type="text">
        <input name="show" value="title" type="hidden">
        <input name="tempid" value="1" type="hidden">
        <input name="tbname" value="news" type="hidden">
        <input name="Submit" class="input_submit" value="搜索" type="submit" >
      </form>
    </div>
    <div class="guanzhu">
      <h2>关注我 有惊喜</h2>
      <ul>
        <img src="../../static/blog/images/wx.jpg">
      </ul>
    </div>
    <div class="fenlei">
      <h2>文章分类</h2>
      <ul id="contentType">
      </ul>
    </div>
    <div class="tuijian">
      <h2>站长推荐</h2>
      <ul id="recommandationList"></ul>
    </div>
    <div class="tuijian">
      <h2>阅读排行</h2>
      <ul id="readRankList"></ul>
    </div>
    <!--<div class="cloud">-->
      <!--<h2>文章分类</h2>-->
      <!--<ul id="keyWord"></ul>-->
    <!--</div>-->
  </aside>
  <main>
    <div class="infosbox" >
      <div class="newsview">
        <h3 class="news_title"></h3>
        <div class="bloginfo">
          <ul id="contentinfo">
            <li class="author"></li>
            <li class="timer"></li>
            <li class="view"></li>
          </ul>
        </div>
        <div class="tags"></div>
        <div class="news_about"><strong>简介</strong></div>
        <div class="news_con">
          <div id="testEditorMdview"></div>
        </div>
      </div>
      <div class="share">
        <p class="diggit" style="cursor: pointer" onclick="addPraise()"></p>
      </div>
      <div class="nextinfo">
        <p id="nextContent">上一篇：无</p>
        <p id="previousContent">下一篇：无</p>
      </div>
      <div class="news_pl">
        <h2>文章评论</h2>
        <div class="gbko">
        </div>
        <div>
          <p id="0"><a class="saying" name= "0"  onclick="display(this);"><strong>你也来说两句吧（点击此处回复）...</strong></a></p>
        </div>
      </div>
    </div>
  </main>
  <div >
    <form id="replyForm" style="width:90%;display: none;margin: auto" name="replyForm" >
        <p class="yname"><span>邮箱:</span>
          <label >
            <input name="fromId" type="text" placeholder="请输入邮箱" class="inputText" id="fromId"  size="16">*
          </label>
        </p>
        <p class="yzm"><span>验证码:</span>
          <label>
            <input name="validCode" placeholder="请输入验证码" type="text" class="inputText" size="16">*
            <img style="width: 95px;height: 25px;display: block;float: right" id = "validCode" src="../validCodeImg/1" onclick="changeCode();">
          </label>
        </p>
        <input name="pId" type="hidden" id="pId" >
        <label >
          <textarea placeholder="欢迎留言，字数最多200字" name="message" rows="6" id="saytext" style="resize: none"></textarea>
        </label>
        <input type="button" value="评论" class="btn2" onclick = "saveMsg();" style="width: 100px;height: 40px;" />
        <input name="toId" type="hidden" id="toId" >
        <input name="contentId" type="hidden" id="contentId" >
    </form>
  </div>
</article>
<footer>
  <p>版权所有：<a href="/blog/index" target="_blank">Newtol个人博客</a> <a href="/">黔ICP备17003873号</a></p>
</footer>
<a href="#" class="cd-top">Top</a>
</body>
<script type="text/javascript">
  $(function () {
      getMsgByContentId();
  });
  // 获取评论
  function getMsgByContentId() {
      var msgList;
      $.ajax({
          url:"../msg?contentId="+contentId,
          dataType:'json',
          async: false,
          success:function(json){
             msgList = json.data;
          }
      });
      if(msgList.length>0){
          for(var i in msgList){
              var a ="<a style='display:block;font-size:14px;text-align:right;font-weight:400;' name ='"+msgList[i].msgId+"' fromId='"+msgList[i].fromId+"' onclick='display(this)'>回复</a>";
              var time ="<span style='display: block;float: right'>"+msgList[i].createTime+"</span>";
              var  p1= "<p class='btime'>"+time+msgList[i].fromId+"</p>";
              var p2 = "<p class='fbinfo'>"+msgList[i].message+"</p>";
              $(".gbko").append("<div class=\"fb\" id='"+msgList[i].msgId+"'><ul>" +p1+p2+a+"</ul></div>");
              getDiscuss(msgList[i].msgId);
          }
      }
  }
  //显示
//  function show() {
//      if(document.getElementById('saypl').style.display ==="none"){
//          document.getElementById('saypl').style.display ="";
//      }else {
//          document.getElementById('saypl').style.display ="none";
//      }
//  }
  // 判断是否已经展示form表单
  var Key;
  function display(obj) {
      var id = obj.name;
      if(Key===obj.name && document.getElementById('replyForm').style.display ===""){
          document.getElementById('replyForm').style.display ="none"
      }else {
          document.getElementById('replyForm').style.display ="";
          $("#replyForm").appendTo(document.getElementById(id));
          document.getElementById("pId").value =id;
          document.getElementById("toId").value = obj.getAttribute("fromId");
          Key = obj.name;
      }
  }

  // 保存二级评论
  function saveMsg() {
      changeCode();
      if(!CheckPl()){
          return;
      }
      document.getElementById("contentId").value = getContentId();
      $.ajax({
          type: 'POST',
          url:"../msg",
          dataType:'json',
          async: false,
          data:$("#replyForm").serialize(),
          success:function(json){
              var data = json.data; 2
              if(json.errorCode===0){
                  alert("已经收到你的评论啦！");
                  $("#replyForm").remove();
                  window.location.reload();
              }else {
                  alert(json.errorMsg);
              }
          }
      });
  }
  function CheckPl(){
      var obj = document.replyForm;
      // 检验邮箱是否为邮箱
      var reg = /^\w+((.\w+)|(-\w+))@[A-Za-z0-9]+((.|-)[A-Za-z0-9]+).[A-Za-z0-9]+$/;

      if(obj.fromId.value==""){
          alert("邮箱不可为空");
          obj.fromId.focus();
          return false;
      }else if(!reg.test(obj.fromId.value)){
          alert("邮箱格式不正确");
          return false;
      }
      // 检验是否有输入留言
      if(obj.saytext.value=="")
      {
          alert("您没什么话要说吗？");
          obj.saytext.focus();
          return false;
      }
      // 设置被评论的文章
      return true;
  }
  // 生成二级评论节点
  function createMsgNode(data) {
      var time ="<span style='float: right' >"+data.createTime+"</span>";
      $("<div class='ecomment' style='width: 90%;display: block;margin: auto;background-color: #efefef'><span class=\"ecommentauthor\">"+data.fromId+"回复 :"+data.toId+time+"</span>" + "<p class=\"ecommenttext\">"+data.message+"</p>" + "</div>").appendTo(document.getElementById(data.pid));

  }
  // 获取二级评论
  function getDiscuss(pId) {
      var discussList;
      $.ajax({
          url:"../msg2?pId="+pId,
          dataType:'json',
          async: false,
          success:function(json){
              discussList = json.data;
          }
      });
      if(discussList.length>0){
          for(var i in discussList){
              createMsgNode(discussList[i]);
          }
      }
  }

  function changeCode() {
      document.getElementById("validCode").src ="/validCodeImg/"+Math.random();
  }


</script>
</html>
